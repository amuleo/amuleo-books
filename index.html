<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="">
    <meta name="msapplication-navbutton-color" content="">
    <meta name="apple-mobile-web-app-status-bar-style" content="">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <title>کتابخونه عمو لئو</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        /* تعریف فونت Mikhak */
        @font-face {
            font-family: 'Mikhak';
            src: url('fonts/Mikhak.woff2') format('truetype');
        }

        /* تعریف متغیرهای CSS برای تم روشن و تاریک */
        :root {
            --bg: #eef1f6;
            --card: #ffffff;
            --border: #e5e5e5;
            --text: #333;
            --hover: #dbdce0;
            --span: #9e8e71;
            /* New variables for pin indicator styling in light mode */
            --pin-indicator-shadow: none; /* No shadow in light mode */
            --pin-indicator-border: 1px solid var(--text); /* Border matching text color in light mode */
        }

        /* استایل‌های تم تاریک */
        body.dark {
            --bg: #212121;
            --card: #303030;
            --border: #666;
            --text: #f0f0f0;
            --hover: #1a1a1c;
            /* New variables for pin indicator styling in dark mode */
            --pin-indicator-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); /* Shadow in dark mode */
            --pin-indicator-border: 1px solid var(--border); /* Border matching general border in dark mode */
        }

        /* استایل اسکرول‌بار برای مرورگرهای WebKit */
        ::-webkit-scrollbar {
            width: 5px;
            height: 5px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--text);
            border-radius: 5px;
        }

        /* استایل اسکرول‌بار برای فایرفاکس */
        html {
            scrollbar-width: thin;
            scrollbar-color: var(--bg);
        }

        /* استایل کلی بدنه صفحه */
        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg);
            font-family: 'Mikhak', sans-serif;
            color: var(--text);
            direction: rtl;
            font-size: 1.1rem;
            text-align: center;
        }

        .container {
            max-width: 800px;
            margin: auto;
            padding: 100px 10px;
        }

        /* استایل هدر */
        .header {
            display: flex;
            position: fixed;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            background-color: var(--card);
            padding: 15px;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
            height: 60px;
        }

        .header h1 {
            margin-right: 40px;
            color: var(--text);
            font-size: 1.5rem;
        }

        /* استایل دکمه تغییر تم */
        .theme-toggle {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            border: none;
            background-color: var(--bg);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .theme-toggle i {
            color: var(--text);
            font-size: 18px;
        }

        /* استایل‌های Modal انتخاب تم */
        .theme-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5); /* پوشش نیمه‌شفاف */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000; /* بالاتر از هدر */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }

        .theme-modal.show {
            opacity: 1;
            visibility: visible;
        }

        .theme-modal-content {
            background-color: var(--card);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            text-align: center;
            position: relative;
            max-width: 350px; /* تنظیم عرض */
            width: 90%; /* پیش‌فرض برای موبایل */
            margin: 0 15px; /* فاصله ۱۵ پیکسلی از چپ و راست در موبایل */
            transform: translateY(-20px); /* افست اولیه برای انیمیشن */
            transition: transform 0.3s ease-in-out;
        }

        .theme-modal.show .theme-modal-content {
            transform: translateY(0); /* افکت اسلاید به داخل */
        }

        .close-modal-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text);
            cursor: pointer;
            transition: color 0.2s;
        }

        .close-modal-btn:hover {
            color: var(--span);
        }

        .theme-options-wrapper {
            display: flex;
            flex-direction: column; /* گزینه‌ها به صورت عمودی در صفحه کوچک */
            gap: 15px;
            margin-top: 20px;
        }

        .theme-option {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 12px 20px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background-color: var(--bg); /* پس‌زمینه کمی متفاوت برای گزینه‌ها */
            color: var(--text);
            font-family: 'Mikhak', sans-serif;
            font-size: 1.1rem;
            cursor: pointer;
            transition: background-color 0.3s, border-color 0.3s, color 0.3s;
        }

        .theme-option:hover {
            background-color: var(--hover);
            border-color: var(--span);
        }

        .theme-option.selected {
            background-color: var(--span); /* برجسته کردن گزینه انتخاب شده */
            color: #ffffff; /* متن سفید برای گزینه انتخاب شده */
            border-color: var(--span);
            box-shadow: 0 0 0 2px rgba(158, 142, 113, 0.5); /* درخشش ملایم */
        }

        .theme-option.selected i {
            color: #ffffff; /* اطمینان از مطابقت رنگ آیکون با متن برای گزینه انتخاب شده */
        }

        .theme-option i {
            font-size: 1.2rem;
            color: var(--text); /* رنگ پیش‌فرض آیکون */
            transition: color 0.3s;
        }

        /* تنظیمات واکنش‌گرا برای گزینه‌های تم */
        @media (min-width: 481px) {
            .theme-options-wrapper {
                flex-direction: row; /* چیدمان افقی در صفحه بزرگتر */
                justify-content: space-around;
            }
            .theme-option {
                flex: 1; /* توزیع فضای مساوی */
            }
            .theme-modal-content {
                margin: auto; /* حذف margin افقی برای صفحات بزرگتر */
            }
        }

        /* استایل Summary Box */
        .summary-box {
            background-color: var(--card);
            border: none;
            border-radius: 10px;
            padding: 15px;
            margin: 15px auto;
            max-width: 800px;
            width: 100%;
            box-sizing: border-box;
        }

        /* استایل Skeleton Loader برای Summary Box (یکسان‌سازی با کارت‌های کتاب) */
        .summary-box-skeleton {
            background-color: var(--card); /* Base background color */
            border-radius: 10px;
            padding: 15px;
            margin: 15px auto; /* حفظ حاشیه و مرکزیت */
            max-width: 800px; /* حفظ حداکثر عرض */
            width: 100%;
            height: 80px; /* ارتفاع ثابت برای اسکلتون خلاصه */
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: space-around; /* یکسان‌سازی با کارت‌های اسکلتون */
            align-items: flex-start;
            animation: shimmer 1.5s infinite linear;
            /* Removed direct linear-gradient from container to match card skeleton */
            background-size: 800px 100%;
            opacity: 1 !important;
        }

        /* استایل خطوط اسکلتون (یکسان برای خلاصه و کارت‌ها) */
        .summary-box-skeleton .skeleton-line,
        .card.skeleton .skeleton-line {
            height: 1em;
            background-color: var(--border);
            border-radius: 3px;
            margin-bottom: 0.5em;
            animation: shimmer 1.5s infinite linear;
            background: linear-gradient(to right, var(--border) 8%, var(--hover) 18%, var(--border) 33%);
            background-size: 800px 100%;
        }

        .summary-box-skeleton .skeleton-line:nth-child(1) {
            width: 90%;
        }
        .summary-box-skeleton .skeleton-line:nth-child(2) {
            width: 70%;
        }


        /* استایل کارت‌ها */
        .card {
            background-color: var(--card);
            border: none;
            border-radius: 10px;
            padding: 15px;
            margin: 15px auto;
            max-width: 800px;
            width: 100%;
            box-sizing: border-box;
            position: relative; /* برای موقعیت‌دهی مطلق نشانگر پین */
            overflow: hidden;
            min-height: 250px;
            cursor: pointer;
            opacity: 0; /* در ابتدا پنهان برای افکت فید-این */
            transition: opacity 0.5s ease-in-out;
        }

        /* استایل‌های Skeleton Loader برای کارت‌ها */
        .card.skeleton {
            height: 150px; /* ارتفاع ثابت برای کارت‌های اسکلتون */
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            align-items: flex-start;
            padding: 15px;
            opacity: 1 !important; /* مطمئن شوید که در ابتدا قابل مشاهده است */
        }

        .card.skeleton .skeleton-line:nth-child(1) {
            width: 80%;
        }
        .card.skeleton .skeleton-line:nth-child(2) {
            width: 95%;
        }
        .card.skeleton .skeleton-line:nth-child(3) {
            width: 70%;
        }

        /* انیمیشن shimmer برای Skeleton Loaders */
        @keyframes shimmer {
            0% {
                background-position: -468px 0;
            }
            100% {
                background-position: 468px 0;
            }
        }

        /* افکت فید-این برای محتوای بارگذاری شده */
        .card.fade-in {
            opacity: 1;
        }

        .card-content {
            position: relative;
            z-index: 1;
            text-align: justify;
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .card hr {
            border: none;
            border-top: 1px solid var(--border);
            margin: 8px 0;
            opacity: 0.5;
        }

        @media (max-width: 480px) {
            body { font-size: 1rem; }
            .card-content { font-size: 0.9rem; }
            .container { padding: 80px 20px; }
            .header { height: 40px; }
        }

        /* استایل پاپ‌آپ */
        #popupModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .modal-content {
            background: var(--card);
            border-radius: 10px;
            padding: 15px;
            margin: 0 15px;
            max-width: 500px;
            width: calc(100% - 30px);
            height: 300px; /* ارتفاع ثابت */
            display: flex;
            flex-direction: column;
        }
        /* پاراگراف پاپ‌آپ با قابلیت اسکرول؛ از پدینگ و مارجین پایین برای فاصله استفاده شده */
        .modal-content p#popupText {
            overflow-y: scroll;
            white-space: normal;
            flex: 1;
            margin-bottom: 15px;
        }
        /* دکمه بستن پاپ‌آپ (تمام عرض) با استایل هاور */
        #closePopup {
            background: var(--bg);
            border: none;
            border-radius: 5px;
            padding: 10px 20px;
            cursor: pointer;
            font-family: 'Mikhak', sans-serif;
            color: var(--text);
            width: 100%;
            transition: background-color 0.3s;
        }
        #closePopup:hover {
            background-color: var(--hover);
        }

        .load-more-btn {
            background-color: var(--card);
            font-family: 'Mikhak', sans-serif;
            color: var(--text);
            border: none;
            padding: 10px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .load-more-btn:hover {
            background-color: var(--hover);
        }

        p {
            text-align: justify;
        }

        .summary-box p {
            display: inline-block;
            text-align: justify;
            margin: 0;
        }

        .justi{
            display: inline-block;
            text-align: justify;
            margin: 0;
        }

        .label {
            color: var(--span);
        }

        .typing::after {
            content: "...";
            display: inline-block;
            animation: typingDots 1.5s infinite steps(3);
        }

        @keyframes typingDots {
            0% { content: "."; }
            33% { content: ".."; }
            66% { content: "..."; }
        }

        .ticked::after {
            content: " ✓"; /* تیک متنی */
            font-weight: bold; /* تاکید بیشتر */
            opacity: 0;
            animation: fadeTick 2s infinite;
        }

        @keyframes fadeTick {
            0% { opacity: 0; }
            50% { opacity: 1; }
            100% { opacity: 0; }
        }

        .later::after {
            content: " >>"; /* فلش دوتایی نشان‌دهنده خواندن در آینده */
            font-weight: bold;
            opacity: 0;
            animation: fadeArrow 2s infinite;
        }

        @keyframes fadeArrow {
            0% { opacity: 0; }
            50% { opacity: 1; }
            100% { opacity: 0; }
        }

        /* استایل کلاس pitem برای المان‌های اصلی */
        .pitem {
            background: var(--bg);
            padding: 15px;
            border-radius: 15px;
            white-space: nowrap;
            overflow-x: auto;
            scrollbar-width: thin;
        }

        .pitem::-webkit-scrollbar {
            height:1px; /* ضخامت نازک‌تر */
        }

        .pitem::-webkit-scrollbar-thumb {
            background: var(--bg); /* رنگ دسته اسکرول */
            border-radius: 2px;
        }

        .pitem::-webkit-scrollbar-track {
            background: transparent; /* پس‌زمینه مسیر اسکرول */
        }
        /* استایل مشابه pitem برای المان‌های متنی کوچک */
        .sitem {
            font-family: 'Mikhak', sans-serif;
            color: var(--text);
            background-color: var(--span);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.95rem;
            width: 100%;
            text-align: center;
            white-space: nowrap;
            overflow-x: auto;
            scrollbar-width: thin;
        }
        /* ظرف وضعیت کتاب با دو ستون */
        .status-container {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
            max-width: 100%; /* جلوگیری از کشیده شدن بیش از حد */
            box-sizing: border-box; /* محاسبه صحیح عرض */
            flex-wrap: wrap; /* جلوگیری از خروج از کادر */
        }
        .status-right {
            display: flex;
            text-align: center;
            width: 59%;
            max-width: 65%;
        }
        .status-left {
            display: flex;
            text-align: center;
            width: 39.5%;
            max-width: 39.5%;
        }

        /* New flex container for the book title and pin */
        .book-title-container {
            display: flex;
            align-items: center;
            gap: 10px; /* 10px gap between pin and title */
            background: var(--bg); /* Inherit background from the theme */
            padding: 15px; /* Inherit padding from pitem */
            border-radius: 15px; /* Inherit border-radius from pitem */
        }

        .book-title-container .pin-indicator {
            /* The pin indicator styles as defined before, but now within a flex context */
            width: 30px;
            height: 30px;
            background-color: var(--card); /* Should match card background, not general bg */
            border-radius: 10px; /* Match card border-radius */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1;
            box-shadow: var(--pin-indicator-shadow); /* Use variable for shadow */
            transition: background-color 0.3s, border-color 0.3s, box-shadow 0.3s;
            border: var(--pin-indicator-border); /* Use variable for border */
            flex-shrink: 0; /* Prevent it from shrinking */
        }

        .book-title-container .pin-indicator i {
            color: var(--text);
            font-size: 1rem;
        }

        @media (max-width: 480px) {
            .book-title-container .pin-indicator {
                width: 25px;
                height: 25px;
                font-size: 0.8rem;
            }
        }

        /* Styles for pitem when it's inside book-title-container */
        .book-title-container .pitem {
            flex-grow: 1; /* Allow the title text to take remaining space */
            margin: 0; /* Remove default paragraph margin */
            text-align: justify; /* Keep text justified */
            /* Removed white-space: normal and overflow-x: hidden to allow pitem's default nowrap and auto scroll */
            background: none; /* Remove background from pitem itself */
            padding: 0; /* Remove padding from pitem itself */
            border-radius: 0; /* Remove border-radius from pitem itself */
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <span class="fa-solid fa-book">&nbsp;</span>
                کتابخونۀ <a href="https://amuleo.ir" target="_blank" style="color: var(--span); text-decoration: none;">عمو لئو</a>
            </h1>
            <button class="theme-toggle" id="themeBtn" title="تغییر حالت">
                <i class="fas fa-sun" id="themeIcon"></i>
            </button>
        </div>

        <div id="themeModal" class="theme-modal">
            <div class="theme-modal-content">
                <button class="close-modal-btn" id="closeThemeModal">&times;</button>
                <div class="theme-options-wrapper">
                    <button class="theme-option" id="autoTheme" data-theme="auto">
                        <i class="fas fa-sync-alt"></i>
                        <span>خودکار</span>
                    </button>
                    <button class="theme-option" id="lightTheme" data-theme="light">
                        <i class="fas fa-sun"></i>
                        <span>روشن</span>
                    </button>
                    <button class="theme-option" id="darkTheme" data-theme="dark">
                        <i class="fas fa-moon"></i>
                        <span>تاریک</span>
                    </button>
                </div>
            </div>
        </div>

        <div id="summarySkeletonPlaceholder"></div>
        <div id="bookContainer"></div>
    </div>

    <div id="popupModal">
        <div class="modal-content">
            <p id="popupText" class="pitem"></p>
            <button id="closePopup"><strong>بستن</strong></button>
        </div>
    </div>

    <script>
        /*--------------------------
            توابع کمکی (کوکی، به‌روزرسانی تم)
        ---------------------------*/
        function setCookie(name, value, days) {
            const d = new Date();
            d.setTime(d.getTime() + (days * 24 * 60 * 60 * 1000));
            let expires = "expires=" + d.toUTCString();
            document.cookie = name + "=" + value + ";" + expires + ";path=/";
        }

        function getCookie(name) {
            let nameEq = name + "=";
            let ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i].trim();
                if (c.indexOf(nameEq) === 0) return c.substring(nameEq.length, c.length);
            }
            return "";
        }

        function updateThemeColor(color) {
            let themeMetaTag = document.querySelector('meta[name="theme-color"]');
            if (!themeMetaTag) {
                themeMetaTag = document.createElement('meta');
                themeMetaTag.setAttribute('name', 'theme-color');
                document.head.appendChild(themeMetaTag);
            }
            themeMetaTag.setAttribute('content', color);
        }

        /*--------------------------
            کد مربوط به تغییر تم (شب و روز) با پاپ‌آپ جدید
        ---------------------------*/
        const themeBtn = document.getElementById("themeBtn");
        const themeIcon = document.getElementById("themeIcon");
        const themeModal = document.getElementById("themeModal");
        const closeThemeModalBtn = document.getElementById("closeThemeModal");
        const autoThemeBtn = document.getElementById("autoTheme");
        const lightThemeBtn = document.getElementById("lightTheme");
        const darkThemeBtn = document.getElementById("darkTheme");

        // تابع مرکزی برای اعمال تم بر اساس ترجیح (auto, light, dark)
        function applyTheme(preference) {
            const body = document.body;
            let actualThemeIsDark;

            if (preference === "auto") {
                actualThemeIsDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            } else {
                actualThemeIsDark = (preference === "dark");
            }

            body.classList.toggle("dark", actualThemeIsDark);
            themeIcon.className = actualThemeIsDark ? "fas fa-moon" : "fas fa-sun";
            updateThemeColor(actualThemeIsDark ? "#333" : "#f9fafd");
            // ذخیره حالت واقعی تم (dark/light) در کوکی 'theme'
            setCookie("theme", actualThemeIsDark ? "dark" : "light", 365);

            // هایلایت کردن گزینه انتخاب شده در پاپ‌آپ
            document.querySelectorAll('.theme-option').forEach(option => {
                option.classList.remove('selected');
                if (option.dataset.theme === preference) {
                    option.classList.add('selected');
                }
            });
        }

        // باز کردن پاپ‌آپ انتخاب تم با کلیک روی دکمه
        themeBtn.addEventListener("click", () => {
            themeModal.classList.add("show");
        });

        // بستن پاپ‌آپ با کلیک روی دکمه بستن یا بیرون از محتوا
        closeThemeModalBtn.addEventListener("click", () => {
            themeModal.classList.remove("show");
        });

        themeModal.addEventListener("click", (e) => {
            if (e.target === themeModal) { // اگر روی پس‌زمینه کلیک شد
                themeModal.classList.remove("show");
            }
        });

        // رویدادهای کلیک برای گزینه‌های تم در پاپ‌آپ
        autoThemeBtn.addEventListener("click", () => {
            setCookie("theme_preference", "auto", 365);
            applyTheme("auto");
            themeModal.classList.remove("show");
        });

        lightThemeBtn.addEventListener("click", () => {
            setCookie("theme_preference", "light", 365);
            applyTheme("light");
            themeModal.classList.remove("show");
        });

        darkThemeBtn.addEventListener("click", () => {
            setCookie("theme_preference", "dark", 365);
            applyTheme("dark");
            themeModal.classList.remove("show");
        });

        // گوش دادن به تغییرات تم سیستم برای حالت "خودکار"
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            if (getCookie("theme_preference") === "auto") {
                applyTheme("auto");
            }
        });

        /*--------------------------
            توابع بارگذاری کتاب‌ها از Cloudflare Worker با Skeleton Loader
        ---------------------------*/

        // تابع برای ایجاد یک کارت اسکلتون
        function createSkeletonCard() {
            const skeletonCard = document.createElement("div");
            skeletonCard.className = "card skeleton";
            for (let i = 0; i < 3; i++) {
                const line = document.createElement("div");
                line.className = "skeleton-line";
                skeletonCard.appendChild(line);
            }
            return skeletonCard;
        }

        // تابع برای ایجاد یک اسکلتون برای Summary Box
        function createSummarySkeleton() {
            const summarySkeleton = document.createElement("div");
            summarySkeleton.className = "summary-box-skeleton";
            for (let i = 0; i < 2; i++) { // دو خط برای خلاصه
                const line = document.createElement("div");
                line.className = "skeleton-line";
                summarySkeleton.appendChild(line);
            }
            return summarySkeleton;
        }

        /**
         * بارگذاری کتاب‌ها از Cloudflare Worker، ایجاد خلاصه‌ای از اطلاعات
         * و نمایش کتاب‌ها به‌صورت کارد. همچنین رویداد دکمه "نمایش بیشتر" جهت
         * افزودن کتاب‌های بیشتر به صفحه نیز مدیریت می‌شود.
         */
        async function loadBooks() {
            const bookContainer = document.getElementById('bookContainer');
            const summarySkeletonPlaceholder = document.getElementById('summarySkeletonPlaceholder');
            const header = document.querySelector('.header');

            // نمایش اسکلتون خلاصه قبل از بارگذاری داده‌ها
            const summarySkeleton = createSummarySkeleton();
            header.insertAdjacentElement('afterend', summarySkeleton);


            // نمایش 5 کارت اسکلتون قبل از بارگذاری داده‌ها
            for (let i = 0; i < 5; i++) {
                bookContainer.appendChild(createSkeletonCard());
            }

            try {
                // دریافت اطلاعات کتاب‌ها از API
                const response = await fetch("https://book-manager-worker.immohammaddavoodi.workers.dev/list-books");
                if (!response.ok) throw new Error('خطا در دریافت اطلاعات از Worker');

                const data = await response.json();
                let books = [];
                // پردازش ساختار داده دریافتی
                if (Array.isArray(data)) {
                    books = data;
                } else if (data.success) {
                    if (data.results && Array.isArray(data.results.results)) {
                        books = data.results.results;
                    } else if (data.results && Array.isArray(data.results)) {
                        books = data.results;
                    } else {
                        throw new Error("داده‌های دریافتی معتبر نیستند.");
                    }
                } else {
                    throw new Error("خطا در دریافت داده از سرور");
                }

                // تغییرات مربوط به کتاب‌هایی که در عنوان (name یا title) کلمه "pin" دارند:
                books.forEach(book => {
                    let currentTitle = book.name || book.title || "";
                    if (currentTitle && /pin/i.test(currentTitle)) {
                        // پاکسازی کلمه "pin" به صورت global و case‑insensitive و افزودن ایموجی پیش از عنوان
                        let cleanedTitle = currentTitle.replace(/pin/gi, "").trim();
                        // Removed the emoji from here as per user request
                        let newTitle = `${cleanedTitle}`;
                        if (book.name) {
                            book.name = newTitle;
                        } else if (book.title) {
                            book.title = newTitle;
                        }
                        book.isPinned = true;
                    } else {
                        book.isPinned = false;
                    }
                });

                // مرتب‌سازی کتاب‌ها به‌طوری که کتاب‌های پین‌شده در ابتدای لیست قرار گیرند.
                // فرض بر این است که ترتیب اصلی کتاب‌ها از قدیمی به جدید است؛
                // برای نمایش جدیدترین‌ها ابتدا، آرایه‌ها را برعکس می‌کنیم.
                const pinnedBooks = books.filter(book => book.isPinned).reverse();
                const nonPinnedBooks = books.filter(book => !book.isPinned).reverse();
                books = [...pinnedBooks, ...nonPinnedBooks];

                // حذف کارت‌های اسکلتون کتاب
                bookContainer.innerHTML = "";
                // حذف اسکلتون خلاصه
                if (summarySkeleton.parentNode) {
                    summarySkeleton.parentNode.removeChild(summarySkeleton);
                }

                // ایجاد خلاصه آمار کتاب‌ها
                const summaryBox = document.createElement('div');
                summaryBox.className = 'summary-box';

                // فیلتر کردن کتاب‌هایی که وضعیت "خوانده‌ام" (re) هستند
                const readBooks = books.filter(book => book.stat === "re");

                // محاسبه تعداد کتاب‌های خوانده‌شده (همانند قبل)
                const totalReadBooks = readBooks.length;

                // محاسبه کتاب‌های خوانده‌شده در سال جاری (مثلاً ۱۴۰۴)
                const currentYear = 1404; // این مقدار را می‌توان به صورت داینامیک نیز تنظیم کرد
                const readBooksThisYear = readBooks.filter(book => parseInt(book.year) === currentYear).length;
                const zerobook = readBooksThisYear === 0 ? "صفر" : readBooksThisYear;

                // محاسبه مجموع صفحات مطالعه شده از دو بخش:
                // بخش اول: کتاب‌هایی که وضعیتشان "re" است، از ویژگی "pages" یا "page" استفاده می‌شود.
                const pagesFromRE = books
                    .filter(book => book.stat === "re")
                    .reduce((sum, book) => sum + (Number(book.pages) || Number(book.page) || 0), 0);

                // بخش دوم: کتاب‌هایی که وضعیتشان عددی است، مقدار عددی موجود در "stat" جمع می‌شود.
                const pagesFromNumericStat = books
                    .filter(book => book.stat !== "re" && !isNaN(Number(book.stat)))
                    .reduce((sum, book) => sum + Number(book.stat), 0);

                // جمع نهایی تعداد صفحات مطالعه شده
                const totalReadPages = pagesFromRE + pagesFromNumericStat;

                summaryBox.innerHTML = `
                    <p>
                        تا کنون <span class="label">${totalReadBooks}</span> کتاب خوانده‌ام و
                        <span class="label">${totalReadPages}</span> صفحه را پشت سر گذاشته‌ام،
                        در سال جاری <span class="label">${zerobook}</span> کتاب خوانده‌ام.
                    </p>
                `;

                // درج باکس خلاصه درست بعد از هدر صفحه
                document.querySelector('.header').insertAdjacentElement('afterend', summaryBox);

                // تعداد اولیه نمایش کتاب‌ها
                let displayedBooks = 10;
                displayBooks(books, displayedBooks);

                // ایجاد دکمه "نمایش بیشتر" در صورت وجود کتاب‌های بیشتر
                const loadMoreButton = document.createElement('button');
                loadMoreButton.className = 'load-more-btn';
                loadMoreButton.textContent = 'نمایش بیشتر';
                bookContainer.appendChild(loadMoreButton);

                // رویداد کلیک دکمه "نمایش بیشتر"
                loadMoreButton.addEventListener('click', () => {
                    displayedBooks += 10;
                    displayBooks(books, displayedBooks);
                    if (displayedBooks >= books.length) {
                        loadMoreButton.remove();
                        const endMessageContainer = document.createElement('div');
                        endMessageContainer.classList.add('justi');

                        const endMessage = document.createElement('p');
                        endMessage.textContent = 'این آخر لیست است';

                        endMessageContainer.appendChild(endMessage);
                        bookContainer.appendChild(endMessageContainer);
                    }
                });

                /**
                 * تابع نمایش کتاب‌ها به صورت کارد.
                 *
                 * در این تابع:
                 * 1- اطلاعات کتاب مانند نام، نویسنده و تاریخ مطالعه استخراج می‌شود.
                 * 2- دو متغیر برای متن بررسی (بررسی در کارد و بررسی در پاپ‌آپ) تعریف می‌شود:
                 * - برای کارد: اگر مقدار intro موجود باشد، "اینجا کلیک کنید" نمایش داده شود؛
                 * در غیر این صورت "مروری ثبت نشده".
                 * 3- اطلاعات کتاب (نام، نویسنده، تاریخ مطالعه و بررسی) به‌صورت یکپارچه در داخل card.innerHTML تعریف می‌شوند.
                 * 4- در انتهای card.innerHTML، بخش وضعیت (وضعیت خواندن و تعداد صفحات) قرار می‌گیرد.
                 * 5- رویداد کلیک روی کل کارد فعال است؛ همچنین، اگر روی متن بررسی کلیک شود، رویداد متفاوتی به همراه توقف انتشار رویداد اجرا می‌شود.
                 *
                 * @param {Array} books - آرایه‌ای از اشیاء کتاب
                 * @param {number} count - تعداد کتاب‌هایی که باید نمایش داده شوند
                 */
                function displayBooks(books, count) {
                    bookContainer.innerHTML = ''; // پاک کردن محتوای قبلی (شامل اسکلتون‌ها)
                    // نمایش کتاب‌ها از ابتدای آرایه (چون آرایه قبل از این مرتب شده است)
                    books.slice(0, count).forEach((book) => {
                        // استخراج اطلاعات کتاب با در نظر گرفتن مقدار پیش‌فرض در صورت عدم وجود
                        const title = book.name || book.title || "نامشخص";
                        const author = book.author || "ناشناس";
                        const year = book.year || "نامشخص";

                        // تعریف دو متغیر برای متن بررسی:
                        // reviewCardText: برای نمایش در کارد (اگر intro معتبر باشد "اینجا کلیک کنید"، در غیر این صورت "مروری ثبت نشده")
                        // reviewPopupText: برای نمایش در پاپ‌آپ (اگر intro معتبر باشد همان مقدار، در غیر این صورت مقدار پیش‌فرض)
                        const reviewCardText = (book.intro && book.intro.trim() && book.intro.trim().toLowerCase() !== "null")
                            ? "اینجا کلیک کنید" : "مروری ثبت نشده";
                        const reviewPopupText = (book.intro && book.intro.trim() && book.intro.trim().toLowerCase() !== "null")
                            ? book.intro : "مروری بر این کتاب ثبت نشده است";

                        // محاسبه تعداد صفحات و تعیین وضعیت خواندن کتاب به شیوه قبلی
                        const totalPagesCount = book.pages || book.page || 0;
                        let statusText, pagesText;
                        let statusColor = "#9e8e71";
                        let statusAnim = "";
                        if (book.stat !== null && book.stat !== "null" && !isNaN(Number(book.stat))) {
                            statusText = "در حال خواندن";
                            pagesText = `${book.stat}/${totalPagesCount} صفحه`;
                            statusColor = "#798478";
                            statusAnim = "typing";
                        } else if (book.stat === "fe") {
                            statusText = "خواهم خواند";
                            statusColor = "#2179b5";
                            statusAnim = "later";
                            pagesText = `${totalPagesCount} صفحه`;
                        } else if (book.stat === "re") {
                            statusText = "خوانده ام";
                            statusColor = "#0ea960";
                            statusAnim = "ticked";
                            pagesText = `${totalPagesCount} صفحه`;
                        } else {
                            statusText = "نامشخص";
                            pagesText = `${totalPagesCount} صفحه`;
                            statusColor = "#c44040";
                        }

                        // ایجاد نشانگر پین برای کارت‌های پین شده
                        let pinIndicatorHtml = '';
                        if (book.isPinned) {
                            pinIndicatorHtml = `
                                <div class="pin-indicator">
                                    <i class="fa-solid fa-thumbtack"></i>
                                </div>
                            `;
                        }

                        // Construct the title section with the pin indicator
                        const titleSectionHtml = `
                            <div class="book-title-container">
                                ${pinIndicatorHtml}
                                <p class="pitem"><span class="label">نام کتاب</span> │ ${title}</p>
                            </div>
                        `;

                        // ایجاد المان کارد و تعریف ساختار داخلی آن:
                        // - اطلاعات کتاب (نام کتاب، نویسنده، تاریخ مطالعه و بررسی) به صورت منسجم نمایش داده می‌شود.
                        // - بخش بررسی (بررسی) در قالب یک <span> جهت ثبت رویداد کلیک جداگانه تعریف شده است.
                        // - بخش وضعیت (وضعیت خواندن و تعداد صفحات) در انتهای کارد قرار گرفته است.
                        const card = document.createElement('div');
                        card.className = 'card fade-in'; // اضافه کردن کلاس فید-این
                        card.innerHTML = `
                            <div class="card-content">
                                ${titleSectionHtml}
                                <p class="pitem"><span class="label">نویسنده</span> │ ${author}</p>
                                <p class="pitem"><span class="label">تاریخ مطالعه</span> │ ${year}</p>
                                <p class="pitem"><span class="label">بررسی</span> │ <span class="review-text">${reviewCardText}</span></p>
                                <div class="status-container">
                                    <div class="status-right"><p class="sitem ${statusAnim}" style="background-color: ${statusColor}; color: #fff;">${statusText}</p></div>
                                    <div class="status-left"><p class="sitem" style="color: #fff;">${pagesText}</p></div>
                                </div>
                            </div>
                        `;

                        // رویداد کلیک روی کل کارد: نمایش پاپ‌آپ با متن بررسی (بر اساس reviewPopupText)
                        card.addEventListener('click', () => {
                            document.getElementById("popupText").innerHTML = `
                                <strong>شناسه کتاب:</strong> ${book.id}<br>
                                <strong>برسی:</strong> ${reviewPopupText}
                            `;
                            document.getElementById("popupModal").style.display = "flex";
                        });

                        // رویداد کلیک روی متن بررسی (داخل اسپن)؛ اجرای نسخه متفاوت (با توقف انتشار رویداد)
                        const reviewSpan = card.querySelector('.review-text');
                        if (reviewSpan) {
                            reviewSpan.addEventListener('click', (e) => {
                                e.stopPropagation(); // جلوگیری از فراخوانی رویداد کلیک روی کل کارد
                                document.getElementById("popupText").innerHTML = `
                                    <strong>شناسه کتاب:</strong> ${book.id}<br>
                                    <strong>برسی من:</strong> ${reviewPopupText}
                                `;
                                document.getElementById("popupModal").style.display = "flex";
                            });
                        }

                        // اضافه کردن کارد ساخته شده به ظرف کتاب‌ها
                        bookContainer.appendChild(card);
                    });
                }

            } catch (error) {
                console.error("خطا در بارگذاری کتاب‌ها:", error.message);
                // در صورت خطا، اسکلتون‌ها را پنهان کنید و پیام خطا نمایش دهید
                if (summarySkeleton.parentNode) {
                    summarySkeleton.parentNode.removeChild(summarySkeleton);
                }
                bookContainer.innerHTML = "<p style='text-align: center; color: var(--span);'><i class='fas fa-exclamation-circle'></i>&nbsp;خطا در بارگذاری کتاب‌ها.</p>";
                // حذف دکمه "نمایش بیشتر" در صورت خطا
                const loadMoreButton = document.querySelector('.load-more-btn');
                if (loadMoreButton) {
                    loadMoreButton.remove();
                }
            }
        }

        /*--------------------------
            یکپارچه‌سازی همه رویدادها پس از بارگذاری کامل DOM
        ---------------------------*/
        document.addEventListener('DOMContentLoaded', () => {
            // اعمال تم ذخیره‌شده با استفاده از کوکی یا تشخیص تم دستگاه
            const savedPreference = getCookie("theme_preference");
            if (savedPreference) {
                applyTheme(savedPreference);
            } else {
                // به صورت پیش‌فرض روی 'auto' تنظیم شود اگر هیچ ترجیحی ذخیره نشده باشد
                setCookie("theme_preference", "auto", 365);
                applyTheme("auto");
            }

            // بارگذاری کتاب‌ها
            loadBooks();
        });

        // =========================== Popup Close Event ==========================
        document.getElementById("closePopup").addEventListener('click', function() {
            document.getElementById("popupModal").style.display = "none";
        });
    </script>
</body>
</html>
